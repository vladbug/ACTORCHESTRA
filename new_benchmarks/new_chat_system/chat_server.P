-file("chat_server.erl", 1).

-module(chat_server).

-behaviour(gen_server).

-export([start_link/0]).

-export([init/1,
         handle_call/3,
         handle_cast/2,
         handle_info/2,
         terminate/2,
         code_change/3]).

-record(state,{registry_pid, rooms = #{}, context = undefined}).

start_link() ->
    gen_server:start_link({local, chat_server}, chat_server, [], []).

init([]) ->
    {ok, RegistryPid} = client_registry:start_link(),
    {ok, #state{registry_pid = RegistryPid}}.

handle_call({with_context, Context, Msg}, From, State) ->
    StateWithContext = State#state{context = Context},
    chat_server:handle_call(Msg, From, StateWithContext);
handle_call({register_client, ClientName, ClientPid}, From, State) ->
    Context = State#state.context,
    RegistryPid = State#state.registry_pid,
    spawn(fun() ->
                 _Result =
                     simple_wrapper:call(RegistryPid,
                                         {add_client, ClientName,
                                          ClientPid},
                                         Context, chat_server),
                 gen_server:reply(From, {ok, registered})
          end),
    {noreply, State};
handle_call({join_room, ClientName, RoomName}, From, State) ->
    Context = State#state.context,
    Rooms = State#state.rooms,
    RegistryPid = State#state.registry_pid,
    spawn(fun() ->
                 RoomPid =
                     case maps:get(RoomName, Rooms, undefined) of
                         undefined ->
                             {ok, NewRoomPid} =
                                 chat_room:start_link(RoomName),
                             simple_wrapper:call(chat_server,
                                                 {register_room,
                                                  RoomName, NewRoomPid},
                                                 Context, chat_server),
                             NewRoomPid;
                         ExistingRoomPid ->
                             ExistingRoomPid
                     end,
                 simple_wrapper:call(RoomPid,
                                     {add_member, ClientName,
                                      whereis(ClientName)},
                                     Context, chat_server),
                 simple_wrapper:call(RegistryPid,
                                     {join_room, ClientName, RoomName},
                                     Context, chat_server),
                 gen_server:reply(From, {ok, joined})
          end),
    {noreply, State};
handle_call({send_message, ClientName, RoomName, Message}, From, State) ->
    Context = State#state.context,
    Rooms = State#state.rooms,
    spawn(fun() ->
                 case maps:get(RoomName, Rooms, undefined) of
                     undefined ->
                         {ok, RoomPid} = chat_room:start_link(RoomName),
                         simple_wrapper:call(chat_server,
                                             {register_room, RoomName,
                                              RoomPid},
                                             Context, chat_server),
                         simple_wrapper:call(RoomPid,
                                             {broadcast_message,
                                              ClientName, Message},
                                             Context, chat_server),
                         gen_server:reply(From, {ok, message_sent});
                     RoomPid ->
                         simple_wrapper:call(RoomPid,
                                             {broadcast_message,
                                              ClientName, Message},
                                             Context, chat_server),
                         gen_server:reply(From, {ok, message_sent})
                 end
          end),
    {noreply, State};
handle_call({leave_room, ClientName, RoomName}, From, State) ->
    Context = State#state.context,
    Rooms = State#state.rooms,
    RegistryPid = State#state.registry_pid,
    spawn(fun() ->
                 case maps:get(RoomName, Rooms, undefined) of
                     undefined ->
                         gen_server:reply(From, {error, room_not_found});
                     RoomPid ->
                         simple_wrapper:call(RoomPid,
                                             {remove_member, ClientName},
                                             Context, chat_server),
                         simple_wrapper:call(RegistryPid,
                                             {leave_room, ClientName,
                                              RoomName},
                                             Context, chat_server),
                         gen_server:reply(From, {ok, left})
                 end
          end),
    {noreply, State};
handle_call({register_room, RoomName, RoomPid}, _From, State) ->
    Context = State#state.context,
    Rooms = State#state.rooms,
    NewRooms = Rooms#{RoomName => RoomPid},
    {reply, ok, State#state{rooms = NewRooms}};
handle_call(get_rooms, _From, State) ->
    Context = State#state.context,
    {reply, maps:keys(State#state.rooms), State};
handle_call(_Request, _From, State) ->
    Context = State#state.context,
    {reply, {error, unknown_request}, State}.

handle_cast(_Msg, State) ->
    {noreply, State}.

handle_info(_Info, State) ->
    {noreply, State}.

terminate(_Reason, _State) ->
    ok.

code_change(_OldVsn, State, _Extra) ->
    {ok, State}.



